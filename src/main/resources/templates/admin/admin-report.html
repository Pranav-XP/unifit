<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>UniFit | Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #revenueChart {
            width: 80%;
            height: 400px;
            margin: auto;
        }
        canvas {
            max-width: 600px;
            margin: auto;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/admin-dashboard.html}">
    <div th:fragment="content">
        <h1 class="text-3xl lg:text-5xl px-5 py-5 font-bold">Reporting and Analytics</h1>

        <!-- Pie Chart Section -->
        <div>
            <canvas id="revenueChart"></canvas> <!-- Canvas for the Pie chart -->
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Get facility revenue data from the Thymeleaf model
    var facilityRevenues = /*[[${facilityRevenues}]]*/ [];

    // Prepare the data for the chart
    var labels = facilityRevenues.map(function(revenue) {
        return revenue.month; // Extract month names
    });

    var data = facilityRevenues.map(function(revenue) {
        return revenue.totalRevenue; // Extract revenue values
    });

    // Get the canvas element
    var ctx = document.getElementById('revenueChart').getContext('2d');

    // Create the Pie chart
    var revenueChart = new Chart(ctx, {
        type: 'pie', // Pie chart type
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Facility Revenues',
                data: data,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)',
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Facility Monthly Revenues'
                }
            }
        }
    });
    /*]]>*/
</script>

<script>
    const socket = new SockJS("/ws");
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
        stompClient.subscribe("/topic/admin", (notification) => {
            // Handle the incoming notification
            const message = JSON.parse(notification.body);
            console.log("Received Booking Notification:", message);
            // Display the notification to the admin
            displayNotification(message);
        });
    });

    function displayNotification(notification) {
        // Extract booking information
        let bookingId = notification.bookingId;
        let customerName = notification.customerName;
        let facilityName = notification.facilityName;

        // Create a message for the toast
        var message = `${customerName} has made a booking at ${facilityName}.`;

        // Show a toast notification
        Toastify({
            text: message,
            duration: 5000, // Adjust duration as needed
            close: true,
            gravity: "top", // Position of the toast
            position: "right", // Position of the toast
            className: "font-semibold bg-blue-500 hover:bg-blue-600",
            destination: `/admin/booking/${bookingId}`,
        }).showToast();
    }

    function searchTable() {
        // Get the search input value
        var input = document.getElementById("customerNameSearch");
        var filter = input.value.toUpperCase();

        // Get the table body and rows
        var table = document.getElementById("bookingTable");
        var rows = table.getElementsByTagName("tr");

        // Loop through all table rows, and hide those that don't match the search query
        for (var i = 0; i < rows.length; i++) {
            var customerName = rows[i].getElementsByTagName("td")[1]; // Adjust index based on your actual table structure

            if (customerName) {
                var textValue = customerName.textContent || customerName.innerText;

                if (textValue.toUpperCase().indexOf(filter) > -1) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }
    }
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</body>
</html>
