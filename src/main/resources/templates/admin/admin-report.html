<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>UniFit | Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
<div th:replace="~{fragments/admin-dashboard.html}">
    <div th:fragment="content">
        <h1 class="text-3xl lg:text-5xl px-5 py-5 font-bold">Reporting and Analytics</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg shadow-lg">
            <!-- Monthly Revenue Chart (Spanning both columns) -->
            <div id="monthlyRevenueChart" class="col-span-1 md:col-span-2 h-96 bg-white p-4 rounded-lg shadow-md border border-gray-200">
                <!-- The Google Chart for Monthly Revenue will render here -->
            </div>

            <!-- Revenue by Facility Type Chart -->
            <div id="revenueByFacilityChart" class="h-96 bg-white p-2 rounded-lg shadow-md border border-gray-200">
                <!-- The Google Chart for Revenue by Facility Type will render here -->
            </div>

            <!-- Occupancy Rate Chart -->
            <div id="occupancyChart" class="h-96 bg-white p-2 rounded-lg shadow-md border border-gray-200">
                <!-- The Google Chart for Occupancy Rate will render here -->
            </div>
        </div>


        <script type="text/javascript">
            // Load the Google Charts API
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(drawCharts);

            // Function to draw the charts
            async function drawCharts() {
                // Fetch data for monthly revenue
                const monthlyRevenueResponse = await fetch('/api/revenue/monthly');
                const monthlyRevenue = await monthlyRevenueResponse.json();

                // Fetch data for revenue by facility type
                const revenueByFacilityResponse = await fetch('/api/revenue/by-facility');
                const revenueByFacility = await revenueByFacilityResponse.json();

                console.log(revenueByFacility);
                console.log(monthlyRevenue);

                // Draw the Monthly Revenue chart
                drawMonthlyRevenueChart(monthlyRevenue);
                // Draw the Revenue by Facility Type chart
                drawRevenueByFacilityChart(revenueByFacility);
            }

            function drawMonthlyRevenueChart(monthlyRevenue) {
                const data = new google.visualization.DataTable();
                data.addColumn('string', 'Month');
                data.addColumn('number', 'Revenue');

                // Assuming `monthlyRevenue` is an array of FacilityRevenue objects
                monthlyRevenue.forEach(item => {
                    data.addRow([item.month, item.totalRevenue]);
                });

                const options = {
                    title: 'Monthly Revenue Comparison',
                    titleTextStyle: {
                        fontSize: 20, // Title font size
                        bold: true // Title boldness
                    },
                    chartArea: {
                        width: '90%', // Use 90% of the container's width
                        height: '70%' // Use 70% of the container's height
                    },
                    hAxis: { title: 'Months' },
                    vAxis: { title: 'Revenue ($)' },
                    colors: ['#76A7FA'],
                    legend: { position: 'left' }
                };

                const chart = new google.visualization.ColumnChart(document.getElementById('monthlyRevenueChart'));
                chart.draw(data, options);
            }

            function drawRevenueByFacilityChart(revenueByFacility) {
                const data = new google.visualization.DataTable();
                data.addColumn('string', 'Facility Type');
                data.addColumn('number', 'Revenue');

                for (const [facility, revenue] of Object.entries(revenueByFacility)) {
                    data.addRow([facility, revenue]);
                }

                const options = {
                    title: 'Revenue by Facility Type',
                    titleTextStyle: {
                        fontSize: 20, // Title font size
                        bold: true // Title boldness
                    },chartArea: {
                        width: '90%', // Use 90% of the container's width
                        height: '70%' // Use 70% of the container's height
                    },
                    pieHole: 0.4,
                    colors: ['#63ffa1', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
                    legend: { position: 'left' }
                };

                const chart = new google.visualization.PieChart(document.getElementById('revenueByFacilityChart'));
                chart.draw(data, options);
            }
        </script>

    </div>
</div>

<script>
    const socket = new SockJS("/ws");
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
        stompClient.subscribe("/topic/admin", (notification) => {
            // Handle the incoming notification
            const message = JSON.parse(notification.body);
            console.log("Received Booking Notification:", message);
            // Display the notification to the admin
            displayNotification(message);
        });
    });

    function displayNotification(notification) {
        // Extract booking information
        let bookingId = notification.bookingId;
        let customerName = notification.customerName;
        let facilityName = notification.facilityName;

        // Create a message for the toast
        var message = `${customerName} has made a booking at ${facilityName}.`;

        // Show a toast notification
        Toastify({
            text: message,
            duration: 5000, // Adjust duration as needed
            close: true,
            gravity: "top", // Position of the toast
            position: "right", // Position of the toast
            className: "font-semibold bg-blue-500 hover:bg-blue-600",
            destination: `/admin/booking/${bookingId}`,
        }).showToast();
    }

    function searchTable() {
        // Get the search input value
        var input = document.getElementById("customerNameSearch");
        var filter = input.value.toUpperCase();

        // Get the table body and rows
        var table = document.getElementById("bookingTable");
        var rows = table.getElementsByTagName("tr");

        // Loop through all table rows, and hide those that don't match the search query
        for (var i = 0; i < rows.length; i++) {
            var customerName = rows[i].getElementsByTagName("td")[1]; // Adjust index based on your actual table structure

            if (customerName) {
                var textValue = customerName.textContent || customerName.innerText;

                if (textValue.toUpperCase().indexOf(filter) > -1) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }
    }
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</body>
</html>
